<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Laravel Permission (Spatie) – Step by Step</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
        }
        h1, h2, h3 {
            color: #2c3e50;
        }
        pre {
            background: #f4f4f4;
            padding: 12px;
            overflow-x: auto;
        }
        code {
            color: #c0392b;
        }
        ul {
            margin-left: 20px;
        }
    </style>
</head>
<body>

<h1>Laravel Permission (Spatie) – Step by Step Guide</h1>

<p>This guide shows how to use <strong>Spatie Laravel Permission</strong> with:</p>
<ul>
    <li>Laravel Blade</li>
    <li>Laravel API</li>
    <li>Middleware</li>
    <li>Controller</li>
</ul>

<hr>

<h2>STEP 1: Install Package</h2>
<pre><code>composer require spatie/laravel-permission</code></pre>

<h3>Publish config & migrations</h3>
<pre><code>php artisan vendor:publish --provider="Spatie\Permission\PermissionServiceProvider"
php artisan migrate</code></pre>

<hr>

<h2>STEP 2: Setup User Model</h2>
<pre><code>use Spatie\Permission\Traits\HasRoles;

class User extends Authenticatable
{
    use HasRoles;
}</code></pre>

<hr>

<h2>STEP 3: Create Roles & Permissions (Seeder)</h2>
<pre><code>php artisan make:seeder RolePermissionSeeder</code></pre>

<pre><code>use Spatie\Permission\Models\Role;
use Spatie\Permission\Models\Permission;

class RolePermissionSeeder extends Seeder
{
    public function run()
    {
        $permissions = [
            'view users',
            'create users',
            'edit users',
            'delete users',
            'create sale',
            'view report',
        ];

        foreach ($permissions as $perm) {
            Permission::firstOrCreate(['name' => $perm]);
        }

        $admin = Role::firstOrCreate(['name' => 'admin']);
        $cashier = Role::firstOrCreate(['name' => 'cashier']);

        $admin->givePermissionTo(Permission::all());
        $cashier->givePermissionTo(['create sale']);
    }
}</code></pre>

<h3>Run Seeder</h3>
<pre><code>php artisan db:seed --class=RolePermissionSeeder</code></pre>

<hr>

<h2>STEP 4: Assign Role to User</h2>
<pre><code>$user = User::find(1);
$user->assignRole('admin');</code></pre>

<hr>

<h2>STEP 5: Middleware Usage</h2>

<h3>Route Permission Protection</h3>
<pre><code>Route::middleware(['permission:create sale'])->group(function () {
    Route::post('/sale', [SaleController::class, 'store']);
});</code></pre>

<h3>Role Middleware</h3>
<pre><code>Route::middleware(['role:admin'])->group(function () {
    Route::get('/users', [UserController::class, 'index']);
});</code></pre>

<hr>

<h2>STEP 6: Controller Usage</h2>

<h3>Permission in Constructor</h3>
<pre><code>class UserController extends Controller
{
    public function __construct()
    {
        $this->middleware('permission:view users')->only('index');
        $this->middleware('permission:create users')->only('store');
    }
}</code></pre>

<h3>Permission in Method</h3>
<pre><code>public function store(Request $request)
{
    if (!auth()->user()->can('create users')) {
        abort(403);
    }

    // create user
}</code></pre>

<hr>

<h2>STEP 7: Blade (View) Usage</h2>

<h3>Show / Hide Button</h3>
<pre><code>@can('create users')
  &lt;button&gt;Add User&lt;/button&gt;
@endcan</code></pre>

<h3>Role Check</h3>
<pre><code>@role('admin')
  &lt;a href="/admin"&gt;Admin Panel&lt;/a&gt;
@endrole</code></pre>

<h3>Multiple Permissions</h3>
<pre><code>@canany(['edit users', 'delete users'])
  &lt;button&gt;Edit&lt;/button&gt;
@endcanany</code></pre>

<hr>

<h2>STEP 8: API Usage (Laravel API)</h2>

<h3>Protect API Route</h3>
<pre><code>Route::middleware(['auth:sanctum', 'permission:view report'])
    ->get('/reports', [ReportController::class, 'index']);</code></pre>

<h3>API Controller</h3>
<pre><code>public function index()
{
    if (!auth()->user()->can('view report')) {
        return response()->json(['message' => 'Forbidden'], 403);
    }

    return response()->json(['data' => 'Report Data']);
}</code></pre>

<hr>

<h2>STEP 9: Middleware Auto-Included</h2>
<ul>
    <li>role</li>
    <li>permission</li>
    <li>role_or_permission</li>
</ul>

<hr>

<h2>STEP 10: Clear Cache (IMPORTANT)</h2>
<pre><code>php artisan permission:cache-reset
php artisan optimize:clear</code></pre>

<hr>

<h2>Real-World Flow</h2>
<ol>
    <li>User logs in</li>
    <li>Role assigned</li>
    <li>Permissions attached</li>
    <li>Middleware checks permission</li>
    <li>Controller executes</li>
    <li>Blade shows UI</li>
</ol>

<hr>

<h2>Best Practices</h2>
<ul>
    <li>Use permissions in routes & middleware</li>
    <li>Use <code>@can</code> in Blade</li>
    <li>Do NOT hardcode role logic</li>
    <li>Always reset permission cache</li>
</ul>

</body>
</html>
